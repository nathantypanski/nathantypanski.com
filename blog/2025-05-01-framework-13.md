----
title: Framework 13 with Nix, Secure Boot, & home-manager
----

I have spent the last week installing and configuring a Framework 13 laptop. My first attempt was to use NixOS (since that's my distro of choice) but the Framework keyboard wasn't detected by either the minimal or graphical NixOS iso. So I went with Arch Linux and installed Nix + Home-Manager to manage _most_ of my system.

## Hardware

I "built" the hardware, meaning my Framework 13 had last-mile assembly conducted by the end-user. This gives a better sense of control & repairability and lets you customize the machine a little more, and it only takes a few minutes to assemble.

I read complaints online about build quality but I am happy to report that I haven't personally noticed anything bothersome besides wishing the bezel were aluminum (a very minor thing).

### Processor & GPU

The processor and GPU are AMD as I'm more satisfied with the power properties and performance of AMD processors overall.

```default
$ cat /proc/cpuinfo | grep '^model name' | head -n1
model name      : AMD Ryzen AI 7 350 w/ Radeon 860M
```

This means that I have the AMD [Pod Security Processor](https://storage.googleapis.com/gweb-uniblog-publish-prod/documents/AMD_GPZ-Technical_Report_FINAL_05_2022.pdf), AMD's parallel to the Intel Management Enginge. The downside is, obviously, these secondary processors are often vulnerable and have privileged access to system hardware. The upside is this provides functionality such as Secure Boot.

As far as I know, it is not currently possible to use CoreBoot on the latest AMD Framework 13, but [experimental support](https://www.phoronix.com/news/Framework-13-AMD-Coreboot-WIP) is in progress for the previous gen of AMD CPUs, leaving me hopeful that we will see it here eventually.

However, the default firmware supports Secure Boot with custom keys, which is good enough for me at the moment.

### Trackpad

The trackpad impressed me. From what I hear, Apple has a patent on trackpads where the full tactile buttonpress can happen over the full Trackpad surface. So this trackpad lets you tap anywhere but the top half-centimeter or so. Not a bad compromise.

In my home-manager config for sway, I used this to get closer to Apple's trackpad settings.

```default
# framework laptop touchpad
"2362:628:PIXA3854:00_093A:0274_Touchpad" = {
  scroll_factor = "0.5";
  accel_profile = "adaptive";
  pointer_accel = "-0.1";
  dwt = "enabled";
  click_method = "clickfinger";
};
```

### Keyboard

The keyboard is good quality. I went with the blank keycaps for style points and to encourage memorizing my keyboard layout, which I'm happy with after some initial hurdles learning how the F-keys function.

### Fingerprint reader

The power button is also a fingerprint reader! It works with out-of-box drivers and seldom fails to register my fingerprint. That's all I could ask for, really.

## Nix vs Arch

As mentioned earlier, NixOS doesn't work on this machine---the keyboard drivers fail to load. I went with Arch Linux and all hardware functions out of the box. I'm happy with this. Then I install Nix (`pacman -S nix`) and wrote a Flake for my home-manager configuration, reusing and improving configs from my NixOS desktop.

I had to come up with a "dividing line" between Nix and Arch, since in many cases they can replace components of one another. I ended up with `home-manager` managing _nearly_ all of my homedir and `pacman` or interactive configuration for the remainder.

## Configuration

### home-manager entrypoint

I have moved to Nix Flakes for my home-manager entrypoint. Flakes are still new to me, but they solve reproducibility issues present with regular Nix.

```default
{
  description = "My full system config (Arch + Home Manager)";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixpkgs-unstable";
    home-manager = {
      url = "github:nix-community/home-manager";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, home-manager, ... }: let
    system = "x86_64-linux";
    username = builtins.getEnv "USER";
    homeDirectory = builtins.getEnv "HOME";

    secrets = {
      # ...
    };
  in {
    homeConfigurations.${username} = home-manager.lib.homeManagerConfiguration {
      pkgs = import nixpkgs {
        inherit system;
      };
      modules = [
        ../home-manager/arch.nix
        {
          programs.home-manager.enable = true;
          home.stateVersion = "24.11";
        }
      ];
      extraSpecialArgs = {
        inherit system;
        secrets = secrets;
        username = username;
        homeDirectory = homeDirectory;
      };
    };
  };
}
```

I know that, in principle, I should have multiple entrypoints here and condition them based on the machine (so I use the same Flake for Darwin and Arch). I'm not there yet.

### Partitioning and Encryption

The system has a TPM so I've been able to do some interesting things, like configure the TPM to store my dm-crypt keys.


I use a configuration where `/boot` and `/boot/efi` are on separate physical partitions and then there's a giant `/dev/nvme0n1p2` partition housing LUKS. Within LUKS is LVM, with the first vg housing (encrypted) swap and the second divided into `/home`, `/var/` and `/` btrfs subvolumes.

```default
$ lsblk
NAME          MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINTS
nvme0n1       259:0    0  1.8T  0 disk
├─nvme0n1p1   259:1    0    2G  0 part  /boot
├─nvme0n1p2   259:2    0  1.8T  0 part
│ └─cryptroot 253:0    0  1.8T  0 crypt
│   ├─vg-swap 253:1    0   32G  0 lvm   [SWAP]
│   └─vg-main 253:2    0  1.8T  0 lvm   /home
│                                       /var
│                                       /
└─nvme0n1p3   259:3    0    2G  0 part  /boot/efi
```

### TPM decryption

Once you have a standard `dm-crypt/LUKS` configuration you can enroll it in the TPM. First ensure you have a TPM.

```default
# ls /dev/tpm*
```

Then you can enroll the device with:

```default
# systemd-cryptenroll /dev/nvme0n1p2 --tpm2-device=auto
```

And you'll see it's attached to the drive:

```default
# cryptsetup luksDump /dev/nvme0n1p2 | grep tpm2 | head
  0: systemd-tpm2
        tpm2-hash-pcrs:   7
        tpm2-pcr-bank:    sha256
        tpm2-pubkey:
        tpm2-pubkey-pcrs:
        tpm2-primary-alg: ecc
```

For more on how to configure this, see [ArchWiki: Encrypting an entire System#Luks on a partition with TPM2 and Secure Boot](https://wiki.archlinux.org/title/Dm-crypt/Encrypting_an_entire_system#LUKS_on_a_partition_with_TPM2_and_Secure_Boot).

Note that the TPM will only grant access to the decryption key if the Secure Boot chain does not show signs of tampering.

### Secure Boot

For Secure Boot I am using `systemd-ukify`

### Fingerprint Unlock

```diff
# diff -c10 /etc/pam.d/system-auth.bk /etc/pam.d/system-auth
*** /etc/pam.d/system-auth.bk   2025-05-01 04:34:54.821598714 -0400
--- /etc/pam.d/system-auth      2025-04-29 23:22:27.302944835 -0400
***************
*** 1,16 ****
--- 1,17 ----
  #%PAM-1.0

  auth       required                    pam_faillock.so      preauth
  # Optionally use requisite above if you do not want to prompt for the password
  # on locked accounts.
  -auth      [success=2 default=ignore]  pam_systemd_home.so
+ auth       sufficient                  pam_fprintd.so
  auth       [success=1 default=bad]     pam_unix.so          try_first_pass nullok
  auth       [default=die]               pam_faillock.so      authfail
  auth       optional                    pam_permit.so
  auth       required                    pam_env.so
  auth       required                    pam_faillock.so      authsucc
  # If you drop the above call to pam_faillock.so the lock will be done also
  # on non-consecutive authentication failures.

  -account   [success=1 default=ignore]  pam_systemd_home.so
  account    required                    pam_unix.so
```
