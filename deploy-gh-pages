#!/usr/bin/env bash

set -euo pipefail

shopt -s extglob

REBUILD="${REBUILD:-yes}"
DEPLOY_BRANCH="${DEPLOY_BRANCH:-master}"

SCRIPT_DIR="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
GIT_ROOT="$(git rev-parse --show-toplevel)"
GH_PAGES_DIR="${GH_PAGES_DIR:-$GIT_ROOT/gh-pages}"

cd "${GIT_ROOT}"

git checkout "${DEPLOY_BRANCH}"
git status --porcelain
COMMIT="$(git rev-parse HEAD)"

if ! [[ "${REBUILD}" == 'no' ]]; then
    nix-shell --command 'stack run -- site clean; stack run -- site build'
fi

git fetch origin gh-pages

cleanup() {
    git worktree remove "${GH_PAGES_DIR}"
}

trap cleanup EXIT INT KILL
if ! [[ -d "${GH_PAGES_DIR}" ]]; then
    git worktree add "${GH_PAGES_DIR}" gh-pages
fi

( 
    cd "${GH_PAGES_DIR}"
    git checkout gh-pages
    git status --porcelain
    rm -rf -- !(CNAME)
    rsync -ah "${GIT_ROOT}/_site/" "${GH_PAGES_DIR}"
    git add *
    git commit -m "add latest files from ${COMMIT}"
    git push origin gh-pages
)
